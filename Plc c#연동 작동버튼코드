using System;
using System.Collections.Generic;
using System.Net.Sockets;
using System.Windows.Threading;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using NModbus;
using ScottPlot;
using ScottPlot.WPF;

namespace SmartQC.ViewModels
{
    public partial class WorkerVeiwModel : ObservableObject
    {
        // ğŸ“Œ Modbus í†µì‹  í•„ë“œ
        private TcpClient? _plcClient;
        private IModbusMaster? _modbusMaster;
        private const string PlcIp = "192.168.0.10"; // PLC IP
        private const int PlcPort = 502;             // Modbus TCP í¬íŠ¸
        private const byte SlaveId = 1;              // PLC ìŠ¬ë ˆì´ë¸Œ ID

        // ğŸ“Œ íƒ€ì´ë¨¸ ë° ì‹œê°í™” ê´€ë ¨
        private readonly DispatcherTimer _timer = new DispatcherTimer();
        private readonly Random random = new Random();
        private readonly List<double> _defectRates = new List<double>();
        private readonly List<double> _timePoints = new List<double>();
        private double _time = 0;
        private DateTime _startTime = DateTime.Now;
        public WpfPlot? PlotControl { get; set; }

        // ğŸ“Œ ë°”ì¸ë”©ìš© ì†ì„±ë“¤
        [ObservableProperty] public double temperature;
        [ObservableProperty] public double humidity;
        [ObservableProperty] public double contamination_level;
        [ObservableProperty] public bool drability;
        [ObservableProperty] public int errorscount;
        [ObservableProperty] public int completecount;
        [ObservableProperty] public int needtocomplete = 40;
        [ObservableProperty] public int progressValue = 0;

        // ğŸ“Œ ìƒì„±ì
        public WorkerVeiwModel()
        {
            // PLC ì—°ê²° ì‹œë„
            try
            {
                _plcClient = new TcpClient(PlcIp, PlcPort);
                var factory = new ModbusFactory();
                _modbusMaster = factory.CreateMaster(_plcClient);
                Console.WriteLine("âœ… PLC ì—°ê²° ì„±ê³µ");
            }
            catch (Exception ex)
            {
                Console.WriteLine("âŒ PLC ì—°ê²° ì‹¤íŒ¨: " + ex.Message);
            }

            // íƒ€ì´ë¨¸ ì„¤ì •
            _timer.Interval = TimeSpan.FromSeconds(1);
            _timer.Tick += Ontimer;
            _timer.Start();
        }

        // ğŸ“Œ ì£¼ê¸°ì ìœ¼ë¡œ ê°’ ìƒì„± (ì˜ˆì‹œë¡œ ìœ ì§€)
        public void Ontimer(object sender, EventArgs e)
        {
            MakeValue(); // Modbus ê¸°ë°˜ì´ë©´ ì´ ë¶€ë¶„ë„ ì‹¤ì œ ì„¼ì„œë¡œ êµì²´ ê°€ëŠ¥
        }

        // ğŸ“Œ ì„ì‹œ ëœë¤ê°’ (ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥)
        public void MakeValue()
        {
            Temperature = Math.Round(random.NextDouble() * 10 + 19.0, 1);
            Humidity = Math.Round(random.NextDouble() * 30 + 35.0, 1);
            Contamination_level = Math.Round(random.NextDouble() * 14 + 3.0, 1);
            Drability = true;
        }

        // ğŸ“Œ OpenCV ë¶ˆëŸ‰ ê²°ê³¼ ì²˜ë¦¬
        public void HandleOpenCVResult()
        {
            completecount++;

            bool isDefective = random.NextDouble() < 0.1;
            if (isDefective)
                errorscount++;

            double defectRate = completecount > 0
                ? (double)errorscount / completecount * 100.0
                : 0;

            _time = (DateTime.Now - _startTime).TotalSeconds;
            _timePoints.Add(_time);
            _defectRates.Add(defectRate);

            UpdatePlot();
        }

        // ğŸ“Œ ScottPlot ê°±ì‹ 
        private void UpdatePlot()
        {
            if (PlotControl == null) return;

            var plt = PlotControl.Plot;
            plt.Clear();
            plt.Add.Scatter(xs: _timePoints.ToArray(), ys: _defectRates.ToArray());
            plt.XLabel("Elapsed Time (s)");
            plt.YLabel("Defect Rate (%)");
            plt.Title("Defect Rate Over Time");
            plt.Axes.SetLimitsY(60, 100);

            PlotControl.Refresh();
        }

        // ğŸ“Œ ì§„í–‰ë¥  ê³„ì‚°
        [RelayCommand]
        private void Updateprogressbar()
        {
            if (Needtocomplete <= 0)
            {
                progressValue = 0;
                return;
            }
            progressValue = (completecount - errorscount) * 100 / Needtocomplete;
        }

        // âœ… ì‹œì‘ ë²„íŠ¼ â†’ MX0 (Coil 0) ON
        [RelayCommand]
        private void StartCommand()
        {
            if (_modbusMaster == null) return;

            try
            {
                _modbusMaster.WriteSingleCoil(SlaveId, 0, true);  // MX0 ON
                _modbusMaster.WriteSingleCoil(SlaveId, 1, false); // MX1 OFF
                Console.WriteLine("â–¶ï¸ ì‘ë™ ì‹œì‘ ì‹ í˜¸ ì „ì†¡ (MX0 ON)");
            }
            catch (Exception ex)
            {
                Console.WriteLine("âŒ ì‹œì‘ ì‹ í˜¸ ì‹¤íŒ¨: " + ex.Message);
            }
        }

        // âœ… ì •ì§€ ë²„íŠ¼ â†’ MX1 (Coil 1) ON
        [RelayCommand]
        private void StopCommand()
        {
            if (_modbusMaster == null) return;

            try
            {
                _modbusMaster.WriteSingleCoil(SlaveId, 0, false); // MX0 OFF
                _modbusMaster.WriteSingleCoil(SlaveId, 1, true);  // MX1 ON
                Console.WriteLine("â¹ ì „ì²´ ì •ì§€ ì‹ í˜¸ ì „ì†¡ (MX1 ON)");
            }
            catch (Exception ex)
            {
                Console.WriteLine("âŒ ì •ì§€ ì‹ í˜¸ ì‹¤íŒ¨: " + ex.Message);
            }
        }
    }
}
